<div class="book-details-container" *ngIf="book" data-cy="book-details">
  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading" data-cy="loading-indicator">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="loading-message">Loading book details...</p>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="hasError" data-cy="error-message">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <h3>Unable to load book details</h3>
    <p>Please check your connection and try again.</p>
    <button mat-button color="primary" (click)="close()" data-cy="back-to-search">
      <mat-icon>arrow_back</mat-icon>
      Back to Search
    </button>
  </div>

  <!-- Book Details Content -->
  <div class="book-details-content" *ngIf="!isLoading && !hasError">
    <!-- Header with back button -->
    <div class="details-header">
      <button
        mat-icon-button
        class="back-button"
        (click)="close()"
        aria-label="Back to search results"
        data-cy="back-button"
      >
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h2 class="details-title">Book Details</h2>
    </div>

    <mat-divider></mat-divider>

    <!-- Main content -->
    <div class="details-body">
      <!-- Book cover and basic info -->
      <div class="book-header">
        <div class="book-cover">
          <img
            [src]="getImageUrl()"
            [alt]="book.title + ' cover'"
            class="cover-image"
            data-cy="book-thumbnail"
          />
        </div>

        <div class="book-basic-info">
          <h1 class="book-title" data-cy="book-title">{{ book.title }}</h1>
          <p class="book-authors" data-cy="book-authors">
            <mat-icon class="info-icon">person</mat-icon>
            {{ formatAuthors(book.authors) }}
          </p>

          <p class="book-publisher" *ngIf="book.publisher" data-cy="book-publisher">
            <mat-icon class="info-icon">business</mat-icon>
            {{ book.publisher }}
          </p>

          <p class="book-published-date" *ngIf="book.publishedDate" data-cy="book-publication-date">
            <mat-icon class="info-icon">calendar_today</mat-icon>
            {{ book.publishedDate }}
          </p>

          <p class="book-page-count" data-cy="book-page-count">
            <mat-icon class="info-icon">book</mat-icon>
            {{ formatPageCount(book.pageCount) }}
          </p>

          <p class="book-language" *ngIf="book.language" data-cy="book-language">
            <mat-icon class="info-icon">language</mat-icon>
            {{ book.language | uppercase }}
          </p>
        </div>
      </div>

      <!-- Rating -->
      <div class="book-rating" *ngIf="book.averageRating" data-cy="book-rating">
        <mat-icon class="rating-icon">star</mat-icon>
        <span class="rating-text" data-cy="book-rating-count">{{
          formatRating(book.averageRating, book.ratingsCount)
        }}</span>
      </div>

      <!-- Categories -->
      <div
        class="book-categories"
        *ngIf="book.categories && book.categories.length > 0"
        data-cy="book-categories"
      >
        <h3 class="section-title">Categories</h3>
        <div class="categories-container">
          <mat-chip-set>
            <mat-chip *ngFor="let category of book.categories" class="category-chip">
              {{ category }}
            </mat-chip>
          </mat-chip-set>
        </div>
      </div>

      <!-- ISBN -->
      <div
        class="book-isbn"
        *ngIf="book.industryIdentifiers && book.industryIdentifiers.length > 0"
        data-cy="book-isbn"
      >
        <h3 class="section-title">ISBN</h3>
        <div class="isbn-container">
          <p *ngFor="let isbn of book.industryIdentifiers">
            {{ isbn.type }}: {{ isbn.identifier }}
          </p>
        </div>
      </div>

      <!-- Description -->
      <div class="book-description" *ngIf="book.description" data-cy="book-description">
        <h3 class="section-title">Description</h3>
        <p class="description-text" [innerHTML]="book.description"></p>
      </div>

      <!-- Action buttons -->
      <div class="action-buttons">
        <button
          mat-raised-button
          color="primary"
          class="preview-button"
          [disabled]="!book.webReaderLink"
          (click)="requestPreview()"
          data-cy="preview-link"
        >
          <mat-icon>visibility</mat-icon>
          Preview Book
        </button>

        <button
          mat-raised-button
          color="primary"
          class="purchase-button"
          [disabled]="true"
          (click)="requestPurchase()"
          data-cy="purchase-link"
        >
          <mat-icon>shopping_cart</mat-icon>
          Purchase Book
        </button>

        <button
          mat-raised-button
          [color]="isFavorite ? 'accent' : 'primary'"
          class="favorite-button"
          (click)="toggleFavorite()"
          data-cy="favorite-button"
        >
          <mat-icon>{{ isFavorite ? 'favorite' : 'favorite_border' }}</mat-icon>
          {{ isFavorite ? 'Remove from Favorites' : 'Add to Favorites' }}
        </button>
      </div>

      <!-- Favorite message -->
      <div class="favorite-message" *ngIf="showFavoriteMessage" data-cy="favorite-message">
        <mat-icon [class]="favoriteMessageIcon">{{ favoriteMessageIcon }}</mat-icon>
        <span>{{ favoriteMessageText }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Empty state -->
<div class="no-book-message" *ngIf="!book && !isLoading" data-cy="error-message">
  <mat-icon class="no-book-icon">book</mat-icon>
  <p>Book not found</p>
  <button mat-button color="primary" routerLink="/" data-cy="back-to-search">
    <mat-icon>arrow_back</mat-icon>
    Back to Search
  </button>
</div>
