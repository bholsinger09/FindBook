import{c as v}from"./chunk-SJIHYLDK.js";import{a as g,c as I}from"./chunk-VG2AWH4E.js";import{A as m,Cc as _,Eb as T,F as i,K as o,Oa as S,U as l,X as R,Yb as u,a as n,aa as d,b as f,n as p,pa as E,q as h,t as c,tb as A,ub as k}from"./chunk-VY3O5C5Q.js";var b=class a{http=d(_);router=d(v);performanceService=d(I);API_BASE_URL=g.authApiUrl||"/api";TOKEN_KEY="findbook_token";REFRESH_TOKEN_KEY="findbook_refresh_token";USER_KEY="findbook_user";authState=E({user:null,token:null,refreshToken:null,isAuthenticated:!1,isLoading:!1,error:null});user=u(()=>this.authState().user);isAuthenticated=u(()=>this.authState().isAuthenticated);isLoading=u(()=>this.authState().isLoading);error=u(()=>this.authState().error);refreshTimer;constructor(){this.initializeAuth()}initializeAuth(){let e=this.getStoredToken(),t=this.getStoredRefreshToken(),r=this.getStoredUser();e&&r&&this.isTokenValid(e)?(this.updateAuthState({user:r,token:e,refreshToken:t,isAuthenticated:!0,isLoading:!1,error:null}),this.scheduleTokenRefresh(e)):this.clearAuthData()}login(e){return this.setLoading(!0),this.performanceService.markStart("auth-login"),this.shouldUseMockAuth()?this.mockLogin(e):this.http.post(`${this.API_BASE_URL}/auth/login`,e).pipe(l(t=>{this.performanceService.markEnd("auth-login"),t.success&&t.data&&this.handleAuthSuccess(t.data)}),i(t=>(this.performanceService.markEnd("auth-login"),this.handleAuthError(t))),o(()=>this.setLoading(!1)))}shouldUseMockAuth(){return!g.features.enableAuth||g.production}mockLogin(e){return m(1e3).pipe(c(()=>{if(this.performanceService.markEnd("auth-login"),e.email&&e.password){let r={user:{id:1,email:e.email,username:e.email.split("@")[0],firstName:e.email.split("@")[0],lastName:"User",roles:["user"],preferences:{theme:"light",language:"en",booksPerPage:12,defaultSortBy:"relevance",emailNotifications:!0,favoriteGenres:[]},createdAt:new Date().toISOString(),lastLoginAt:new Date().toISOString()},token:"mock-jwt-token-"+Date.now(),refreshToken:"mock-refresh-token-"+Date.now(),expiresIn:3600},s={success:!0,data:r,message:"Login successful (demo mode)"};return this.handleAuthSuccess(r),s}else throw new Error("Invalid credentials")}),i(t=>(this.performanceService.markEnd("auth-login"),this.handleAuthError(t))),o(()=>this.setLoading(!1)))}register(e){return this.setLoading(!0),this.performanceService.markStart("auth-register"),this.shouldUseMockAuth()?this.mockRegister(e):this.http.post(`${this.API_BASE_URL}/auth/register`,e).pipe(l(t=>{this.performanceService.markEnd("auth-register"),t.success&&t.data&&this.handleAuthSuccess(t.data)}),i(t=>(this.performanceService.markEnd("auth-register"),this.handleAuthError(t))),o(()=>this.setLoading(!1)))}mockRegister(e){return m(1500).pipe(c(()=>{if(this.performanceService.markEnd("auth-register"),e.email&&e.password&&e.firstName&&e.lastName){let r={user:{id:Date.now(),email:e.email,username:e.email.split("@")[0],firstName:e.firstName,lastName:e.lastName,roles:["user"],preferences:{theme:"light",language:"en",booksPerPage:12,defaultSortBy:"relevance",emailNotifications:!0,favoriteGenres:[]},createdAt:new Date().toISOString(),lastLoginAt:new Date().toISOString()},token:"mock-jwt-token-"+Date.now(),refreshToken:"mock-refresh-token-"+Date.now(),expiresIn:3600},s={success:!0,data:r,message:"Registration successful (demo mode)"};return this.handleAuthSuccess(r),s}else throw new Error("Invalid registration data")}),i(t=>(this.performanceService.markEnd("auth-register"),this.handleAuthError(t))),o(()=>this.setLoading(!1)))}socialAuth(e){return this.setLoading(!0),this.http.post(`${this.API_BASE_URL}/auth/social`,e).pipe(l(t=>{t.success&&t.data&&this.handleAuthSuccess(t.data)}),i(t=>this.handleAuthError(t)),o(()=>this.setLoading(!1)))}logout(){let e=this.authState().refreshToken;return this.clearAuthData(),e?this.http.post(`${this.API_BASE_URL}/auth/logout`,{refreshToken:e}).pipe(i(()=>p),o(()=>{this.router.navigate(["/"])})):(this.router.navigate(["/"]),p)}refreshToken(){let e=this.authState().refreshToken;if(!e)return h(()=>new Error("No refresh token available"));let t=!1,r={refreshToken:e};return this.performanceService.markStart("auth-refresh-token"),this.http.post(`${this.API_BASE_URL}/auth/refresh`,t?{}:r,{withCredentials:t}).pipe(l(s=>{if(this.performanceService.markEnd("auth-refresh-token"),s.success&&s.data){let N=this.authState();this.updateAuthState(f(n({},N),{token:s.data.token,refreshToken:s.data.refreshToken})),this.storeToken(s.data.token),this.storeRefreshToken(s.data.refreshToken),this.scheduleTokenRefresh(s.data.token)}else s.error&&typeof s.error=="string"&&s.error.includes("REFRESH_TOKEN_REUSED")&&(this.clearAuthData(),this.router.navigate(["/auth/login"]))}),i(s=>(this.performanceService.markEnd("auth-refresh-token"),s?.error?.type==="REFRESH_TOKEN_REUSED"||s?.status===401?(this.clearAuthData(),this.router.navigate(["/auth/login"]),h(()=>new Error("Session expired or token reuse detected. Please log in again."))):(this.clearAuthData(),this.router.navigate(["/auth/login"]),h(()=>s)))))}requestPasswordReset(e){let t={email:e};return this.http.post(`${this.API_BASE_URL}/auth/password-reset`,t).pipe(i(r=>this.handleAuthError(r)))}changePassword(e){return this.http.post(`${this.API_BASE_URL}/auth/password-change`,e).pipe(i(t=>this.handleAuthError(t)))}getToken(){return this.authState().token}hasRole(e){return this.user()?.roles.includes(e)??!1}hasAnyRole(e){let t=this.user();return e.some(r=>t?.roles.includes(r))??!1}updateProfile(e){return this.http.put(`${this.API_BASE_URL}/user/profile`,e).pipe(c(t=>t.data),l(t=>{let r=this.authState();this.updateAuthState(f(n({},r),{user:n(n({},r.user),t)})),this.storeUser(t)}),i(t=>this.handleAuthError(t)))}handleAuthSuccess(e){this.updateAuthState({user:e.user,token:e.token,refreshToken:e.refreshToken,isAuthenticated:!0,isLoading:!1,error:null}),this.storeToken(e.token),this.storeRefreshToken(e.refreshToken),this.storeUser(e.user),this.scheduleTokenRefresh(e.token)}handleAuthError(e){let t;return e.status===401?t={type:"INVALID_CREDENTIALS",message:"Invalid email or password",details:e.error}:e.status===404?t={type:"USER_NOT_FOUND",message:"User not found",details:e.error}:e.status===409?t={type:"EMAIL_ALREADY_EXISTS",message:"Email already exists",details:e.error}:e.status===422?t={type:"VALIDATION_ERROR",message:"Validation failed",details:e.error}:e.status===0?t={type:"NETWORK_ERROR",message:"Network error occurred",details:e.error}:t={type:"SERVER_ERROR",message:"Server error occurred",details:e.error},this.setError(t.message),h(()=>t)}clearAuthData(){this.updateAuthState({user:null,token:null,refreshToken:null,isAuthenticated:!1,isLoading:!1,error:null}),localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.REFRESH_TOKEN_KEY),localStorage.removeItem(this.USER_KEY),this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null)}scheduleTokenRefresh(e){this.refreshTimer&&clearTimeout(this.refreshTimer);let t=this.decodeJWT(e);if(t){let r=t.exp*1e3-Date.now()-3e5;r>0&&(this.refreshTimer=setTimeout(()=>{this.refreshToken().subscribe({error:()=>{this.clearAuthData(),this.router.navigate(["/auth/login"])}})},r))}}isTokenValid(e){try{let t=this.decodeJWT(e);if(!t)return!1;let r=Math.floor(Date.now()/1e3);return t.exp>r}catch{return!1}}decodeJWT(e){try{let t=e.split(".");return t.length!==3?null:JSON.parse(atob(t[1]))}catch{return null}}storeToken(e){localStorage.setItem(this.TOKEN_KEY,e)}getStoredToken(){return localStorage.getItem(this.TOKEN_KEY)}storeRefreshToken(e){localStorage.setItem(this.REFRESH_TOKEN_KEY,e)}getStoredRefreshToken(){return localStorage.getItem(this.REFRESH_TOKEN_KEY)}storeUser(e){localStorage.setItem(this.USER_KEY,JSON.stringify(e))}getStoredUser(){let e=localStorage.getItem(this.USER_KEY);return e?JSON.parse(e):null}updateAuthState(e){this.authState.set(n(n({},this.authState()),e))}setLoading(e){this.updateAuthState({isLoading:e})}setError(e){this.updateAuthState({error:e})}static \u0275fac=function(t){return new(t||a)};static \u0275prov=R({token:a,factory:a.\u0275fac,providedIn:"root"})};var ue={SNACKBAR_DURATION:3e3,PERFORMANCE_SUMMARY_DELAY:5e3,LOADING_SPINNER_MIN_DISPLAY:300,DEBOUNCE_SEARCH:300,TOAST_AUTO_HIDE:5e3};var L=["mat-internal-form-field",""],D=["*"],de=(()=>{class a{labelPosition;static \u0275fac=function(r){return new(r||a)};static \u0275cmp=S({type:a,selectors:[["div","mat-internal-form-field",""]],hostAttrs:[1,"mdc-form-field","mat-internal-form-field"],hostVars:2,hostBindings:function(r,s){r&2&&T("mdc-form-field--align-end",s.labelPosition==="before")},inputs:{labelPosition:"labelPosition"},attrs:L,ngContentSelectors:D,decls:1,vars:0,template:function(r,s){r&1&&(A(),k(0))},styles:[`.mat-internal-form-field{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;display:inline-flex;align-items:center;vertical-align:middle}.mat-internal-form-field>label{margin-left:0;margin-right:auto;padding-left:4px;padding-right:0;order:0}[dir=rtl] .mat-internal-form-field>label{margin-left:auto;margin-right:0;padding-left:0;padding-right:4px}.mdc-form-field--align-end>label{margin-left:auto;margin-right:0;padding-left:0;padding-right:4px;order:-1}[dir=rtl] .mdc-form-field--align-end .mdc-form-field--align-end label{margin-left:0;margin-right:auto;padding-left:4px;padding-right:0}
`],encapsulation:2,changeDetection:0})}return a})();export{b as a,de as b,ue as c};
